name: CI-build-apps

on:
  pull_request:
    branches:
      - main

  # Daily build
  schedule:
  - cron: "0 2 * * *"

  push:
    branches:
      - main

  workflow_dispatch:

jobs:
  build-base:
    runs-on:
      - ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build base
        run: |
          cd base/docker
          bash build.sh

      - name: Build and export
        run: |
          docker save --output=${{ runner.temp }}/workflows-base.tar aperturedata/workflows-base:latest

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: workflows-base
          path: ${{ runner.temp }}/workflows-base.tar

  build-test-apps:
    needs:
      - build-base

    strategy:
      matrix:
        app: [
          dataset-ingestion,
          object-detection,
          embeddings-extraction,
          face-detection,
          jupyterlab,
          rag,
          crawl-website,
          text-extraction,
          text-embeddings
        ]
    runs-on:
      - ubuntu-latest
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: workflows-base
          path: ${{ runner.temp }}

      - name: Load image
        run: |
          docker load --input ${{ runner.temp }}/workflows-base.tar
          docker image ls -a

      - uses: aperture-data/common_job_steps@v1
        with:
          registry_username: ${{ fromJson(secrets.DOCKERHUB).username }}
          registry_password: ${{ fromJson(secrets.DOCKERHUB).password }}

      - uses: actions/checkout@v3

      - name: Test app
        env:
          CLEANUP: "true"
          WF_LOGS_AWS_CREDENTIALS: ${{ secrets.WF_LOGS_AWS_CREDENTIALS }}
          WF_DATA_SOURCE_GCP_BUCKET: ${{ secrets.WF_DATA_SOURCE_GCP_BUCKET }}
        run: |
          cd apps/${{ matrix.app }}
          bash test.sh

      - name: Push to docker
        # Only push to docker when merged to main
        # Pushing base to docker should be no-op after the first time
        if: github.event_name == 'push'
        run: |
          cd apps/${{ matrix.app }}
          docker push aperturedata/workflows-base:latest
          docker push aperturedata/workflows-${{ matrix.app }}:latest
